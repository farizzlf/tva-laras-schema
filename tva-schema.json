{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "TVA Script Schema v1.0",
  "type": "object",
  "required": ["project", "style", "continuity", "scenes", "constraints"],
  "properties": {
    "project": {
      "type": "object",
      "required": ["project_id", "version", "assets", "seed"],
      "properties": {
        "project_id": { "type": "string", "pattern": "^[a-z0-9\\-]{3,}$" },
        "version": { "type": "string" },
        "seed": { "type": "integer", "minimum": 0 },
        "rng_provider": { "type": "string", "enum": ["builtin", "stable", "deterministic"] },
        "assets": {
          "type": "object",
          "required": ["characters", "locations", "props", "music", "sfx", "refs"],
          "properties": {
            "characters": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["char_id", "name", "look", "voice_id", "lock"],
                "properties": {
                  "char_id": { "type": "string" },
                  "name": { "type": "string" },
                  "look": {
                    "type": "object",
                    "required": ["model_sheet_ref", "palette", "height_cm", "tags"],
                    "properties": {
                      "model_sheet_ref": { "type": "string" },
                      "palette": {
                        "type": "object",
                        "required": ["primary", "secondary", "skin", "hair", "eye"],
                        "properties": {
                          "primary": { "type": "string", "pattern": "^#([A-Fa-f0-9]{6})$" },
                          "secondary": { "type": "string", "pattern": "^#([A-Fa-f0-9]{6})$" },
                          "skin": { "type": "string", "pattern": "^#([A-Fa-f0-9]{6})$" },
                          "hair": { "type": "string", "pattern": "^#([A-Fa-f0-9]{6})$" },
                          "eye": { "type": "string", "pattern": "^#([A-Fa-f0-9]{6})$" }
                        }
                      },
                      "height_cm": { "type": "integer", "minimum": 30, "maximum": 250 },
                      "tags": { "type": "array", "items": { "type": "string" } }
                    }
                  },
                  "voice_id": { "type": "string" },
                  "voice_style": { "type": "string" },
                  "lock": { "type": "boolean", "const": true }
                }
              }
            },
            "locations": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["loc_id", "name", "env_ref", "time_of_day", "weather", "lock"],
                "properties": {
                  "loc_id": { "type": "string" },
                  "name": { "type": "string" },
                  "env_ref": { "type": "string" },
                  "time_of_day": { "type": "string", "enum": ["dawn","morning","noon","afternoon","dusk","night"] },
                  "weather": { "type": "string" },
                  "lock": { "type": "boolean", "const": true }
                }
              }
            },
            "props": { "type": "array", "items": { "type": "object", "required": ["prop_id","name","ref","lock"], "properties": {
              "prop_id": {"type":"string"}, "name":{"type":"string"}, "ref":{"type":"string"}, "lock":{"type":"boolean","const": true}
            } } },
            "music": { "type": "array", "items": { "type": "object", "required": ["music_id","name","mood","bpm","lock"], "properties": {
              "music_id":{"type":"string"},"name":{"type":"string"},"mood":{"type":"string"},"bpm":{"type":"integer"},"lock":{"type":"boolean","const": true}
            } } },
            "sfx": { "type": "array", "items": { "type": "object", "required": ["sfx_id","name","ref","lock"], "properties": {
              "sfx_id":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"},"lock":{"type":"boolean","const": true}
            } } },
            "refs": { "type": "array", "items": { "type": "object", "required": ["ref_id","type","uri","lock"], "properties": {
              "ref_id":{"type":"string"}, "type":{"type":"string","enum":["image","video","style","lora","embedding"]},
              "uri":{"type":"string"}, "lock":{"type":"boolean","const": true}
            } } }
          }
        }
      }
    },
    "style": {
      "type": "object",
      "required": ["visual", "camera_grammar", "text_policy", "style_lock", "negatives"],
      "properties": {
        "visual": {
          "type": "object",
          "required": ["animation", "render", "resolution", "fps", "aspect", "lighting", "color_management"],
          "properties": {
            "animation": { "type": "string", "enum": ["3D_cartoon_cinematic"] },
            "render": { "type": "string", "enum": ["PBR_soft"] },
            "resolution": { "type": "string", "enum": ["1920x1080"] },
            "fps": { "type": "integer", "enum": [24] },
            "aspect": { "type": "string", "enum": ["16:9"] },
            "lighting": { "type": "string", "enum": ["soft_daylight"] },
            "color_management": { "type": "string", "enum": ["ACEScg_sRGB_out"] }
          }
        },
        "camera_grammar": {
          "type": "array",
          "items": { "type": "string", "enum": [
            "ESTABLISHING","WIDE","MEDIUM","CLOSE","ECU",
            "PAN_L","PAN_R","TILT_UP","TILT_DOWN","DOLLY_IN","DOLLY_OUT","TRUCK_L","TRUCK_R","CRANE_UP","CRANE_DOWN","LOCKED_OFF"
          ] }
        },
        "text_policy": {
          "type": "object",
          "required": ["max_chars_dialogue", "language", "tone", "reading_level"],
          "properties": {
            "max_chars_dialogue": { "type": "integer", "maximum": 3500 },
            "language": { "type": "string", "enum": ["id-ID"] },
            "tone": { "type": "string", "enum": ["ceria_lugas"] },
            "reading_level": { "type": "string", "enum": ["anak_smp_sederhana"] }
          }
        },
        "style_lock": { "type": "boolean", "const": true },
        "negatives": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "continuity": {
      "type": "object",
      "required": ["character_bible", "prop_rules", "continuity_lock"],
      "properties": {
        "character_bible": {
          "type": "array",
          "items": { "type": "object",
            "required": ["char_id","immutable_traits"],
            "properties": {
              "char_id": { "type": "string" },
              "immutable_traits": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          }
        },
        "prop_rules": { "type": "array", "items": { "type": "string" } },
        "continuity_lock": { "type": "boolean", "const": true }
      }
    },
    "scenes": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["scene_id","duration_sec","location","shots","dialogue","audio","transitions"],
        "properties": {
          "scene_id": { "type": "string", "pattern": "^s[0-9]+(\\.[0-9]+)?$" },
          "duration_sec": { "type": "number", "minimum": 1, "maximum": 20 },
          "location": { "type": "string" },
          "shots": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["shot_id","camera","action","participants","locks"],
              "properties": {
                "shot_id": { "type": "string" },
                "camera": {
                  "type": "object",
                  "required": ["type","move","fov","focus_on"],
                  "properties": {
                    "type": { "type": "string", "enum": ["ESTABLISHING","WIDE","MEDIUM","CLOSE","ECU"] },
                    "move": { "type": "string", "enum": ["LOCKED_OFF","PAN_L","PAN_R","TILT_UP","TILT_DOWN","DOLLY_IN","DOLLY_OUT","TRUCK_L","TRUCK_R","CRANE_UP","CRANE_DOWN"] },
                    "fov": { "type": "string", "enum": ["28mm","35mm","50mm","85mm"] },
                    "focus_on": { "type": "string" }
                  }
                },
                "action": { "type": "string" },
                "participants": {
                  "type": "array",
                  "items": { "type": "string" }
                },
                "locks": {
                  "type": "object",
                  "required": ["character_costume","palette","lighting"],
                  "properties": {
                    "character_costume": { "type": "boolean", "const": true },
                    "palette": { "type": "boolean", "const": true },
                    "lighting": { "type": "boolean", "const": true }
                  }
                }
              }
            }
          },
          "dialogue": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["char_id","voice_id","text"],
              "properties": {
                "char_id": { "type": "string" },
                "voice_id": { "type": "string" },
                "text": { "type": "string", "maxLength": 3500 }
              }
            }
          },
          "audio": {
            "type": "object",
            "required": ["music_cue","sfx_cues"],
            "properties": {
              "music_cue": { "type": "string" },
              "sfx_cues": { "type": "array", "items": { "type": "string" } }
            }
          },
          "transitions": {
            "type": "object",
            "required": ["from","to","style"],
            "properties": {
              "from": { "type": "string" },
              "to": { "type": "string" },
              "style": { "type": "string", "enum": ["cut","fade","dissolve","wipe"] }
            }
          }
        }
      }
    },
    "constraints": {
      "type": "object",
      "required": ["forbidden","max_total_duration","checksum"],
      "properties": {
        "forbidden": { "type": "array", "items": { "type": "string" } },
        "max_total_duration": { "type": "number", "maximum": 300 },
        "checksum": { "type": "string", "description": "sha256 of concatenated IDs and locked fields" }
      }
    },
    "violations": { "type": "array", "items": { "type": "string" } }
  }
}
